<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=latin1">
  <style type="text/css">
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #008800; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #AA22FF; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .cm { color: #008800; font-style: italic } /* Comment.Multiline */
body .cp { color: #008800 } /* Comment.Preproc */
body .c1 { color: #008800; font-style: italic } /* Comment.Single */
body .cs { color: #008800; font-weight: bold } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #AA22FF; font-weight: bold } /* Keyword.Constant */
body .kd { color: #AA22FF; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #AA22FF; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #AA22FF } /* Keyword.Pseudo */
body .kr { color: #AA22FF; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #00BB00; font-weight: bold } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BB4444 } /* Literal.String */
body .na { color: #BB4444 } /* Name.Attribute */
body .nb { color: #AA22FF } /* Name.Builtin */
body .nc { color: #0000FF } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #00A000 } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #B8860B } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #BB4444 } /* Literal.String.Backtick */
body .sc { color: #BB4444 } /* Literal.String.Char */
body .sd { color: #BB4444; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BB4444 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BB4444 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BB4444 } /* Literal.String.Single */
body .ss { color: #B8860B } /* Literal.String.Symbol */
body .bp { color: #AA22FF } /* Name.Builtin.Pseudo */
body .vc { color: #B8860B } /* Name.Variable.Class */
body .vg { color: #B8860B } /* Name.Variable.Global */
body .vi { color: #B8860B } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span class="cm">(* Coursera Programming Languages, Homework 3, Provided Code *)</span><span class="w"></span>

<span class="k">exception</span><span class="w"> </span><span class="n">NoAnswer</span><span class="w"></span>

<span class="k">datatype</span><span class="w"> </span><span class="n">pattern</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Wildcard</span><span class="w"></span>
<span class="w">		 </span><span class="p">|</span><span class="w"> </span><span class="n">Variable</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">string</span><span class="w"></span>
<span class="w">		 </span><span class="p">|</span><span class="w"> </span><span class="n">UnitP</span><span class="w"></span>
<span class="w">		 </span><span class="p">|</span><span class="w"> </span><span class="n">ConstP</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">int</span><span class="w"></span>
<span class="w">		 </span><span class="p">|</span><span class="w"> </span><span class="n">TupleP</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">pattern</span><span class="w"> </span><span class="n">list</span><span class="w"></span>
<span class="w">		 </span><span class="p">|</span><span class="w"> </span><span class="n">ConstructorP</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">*</span><span class="w"> </span><span class="n">pattern</span><span class="w"></span>

<span class="k">datatype</span><span class="w"> </span><span class="n">valu</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Const</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">int</span><span class="w"></span>
<span class="w">	      </span><span class="p">|</span><span class="w"> </span><span class="n">Unit</span><span class="w"></span>
<span class="w">	      </span><span class="p">|</span><span class="w"> </span><span class="n">Tuple</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">valu</span><span class="w"> </span><span class="n">list</span><span class="w"></span>
<span class="w">	      </span><span class="p">|</span><span class="w"> </span><span class="n">Constructor</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">*</span><span class="w"> </span><span class="n">valu</span><span class="w"></span>

<span class="cm">(*val g = fn : (unit -&gt; int) -&gt; (string -&gt; int) -&gt; pattern -&gt; int*)</span><span class="w"></span>
<span class="k">fun</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="n">f1</span><span class="w"> </span><span class="n">f2</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">=</span><span class="w"></span>
<span class="w">    </span><span class="k">let</span><span class="w"> </span>
<span class="w">		</span><span class="k">val</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="n">f1</span><span class="w"> </span><span class="n">f2</span><span class="w"> </span>
<span class="w">    </span><span class="k">in</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">of</span><span class="w"></span>
<span class="w">		    </span><span class="n">Wildcard</span><span class="w">          </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">f1</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="w">		  </span><span class="p">|</span><span class="w"> </span><span class="n">Variable</span><span class="w"> </span><span class="n">x</span><span class="w">        </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">f2</span><span class="w"> </span><span class="n">x</span><span class="w"></span>
<span class="w">		  </span><span class="p">|</span><span class="w"> </span><span class="n">TupleP</span><span class="w"> </span><span class="n">ps</span><span class="w">         </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="n">foldl</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="n">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">ps</span><span class="w"></span>
<span class="w">		  </span><span class="p">|</span><span class="w"> </span><span class="n">ConstructorP</span><span class="p">(_,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">p</span><span class="w"></span>
<span class="w">		  </span><span class="p">|</span><span class="w"> </span><span class="p">_</span><span class="w">                 </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>

<span class="cm">(**** for the challenge problem only ****)</span><span class="w"></span>

<span class="k">datatype</span><span class="w"> </span><span class="n">typ</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Anything</span><span class="w"></span>
<span class="w">	     </span><span class="p">|</span><span class="w"> </span><span class="n">UnitT</span><span class="w"></span>
<span class="w">	     </span><span class="p">|</span><span class="w"> </span><span class="n">IntT</span><span class="w"></span>
<span class="w">	     </span><span class="p">|</span><span class="w"> </span><span class="n">TupleT</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">typ</span><span class="w"> </span><span class="n">list</span><span class="w"></span>
<span class="w">	     </span><span class="p">|</span><span class="w"> </span><span class="n">Datatype</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">string</span><span class="w"></span>

<span class="cm">(**** you can put all your code here ****)</span><span class="w"></span>
<span class="cm">(* Author: Edwin Dalorzo *)</span><span class="w"></span>

<span class="k">fun</span><span class="w"> </span><span class="n">only_capitals</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="p">(</span><span class="n">Char</span><span class="p">.</span><span class="n">isUpper</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="k">fun</span><span class="w"> </span><span class="n">longest_string1</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">foldl</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">&gt;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="k">fun</span><span class="w"> </span><span class="n">longest_string2</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">foldl</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="k">fun</span><span class="w"> </span><span class="n">longest_string_helper</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">foldl</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="k">val</span><span class="w"> </span><span class="n">longest_string3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">longest_string_helper</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="k">val</span><span class="w"> </span><span class="n">longest_string4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">longest_string_helper</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">&gt;=</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="k">val</span><span class="w"> </span><span class="n">longest_capitalized</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">longest_string1</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="n">only_capitals</span><span class="w"></span>
<span class="k">val</span><span class="w"> </span><span class="n">rev_string</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">implode</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="n">rev</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="n">explode</span><span class="w"></span>

<span class="cm">(*</span>
<span class="cm">--suboptimal solutions that apply f to all elements of xs</span>
<span class="cm">--while we are only looking for the first SOME.</span>

<span class="cm">fun first_answer f xs = </span>
<span class="cm">	case List.filter isSome (map f xs) of</span>
<span class="cm">	   (SOME x)::xs&#39; =&gt; x</span>
<span class="cm">	  | _ =&gt; raise NoAnswer</span>

<span class="cm">fun first_answer f xs = </span>
<span class="cm">	case List.mapPartial f xs of</span>
<span class="cm">		 [] =&gt; raise NoAnswer</span>
<span class="cm">	   | x::_ =&gt; x</span>
<span class="cm">*)</span><span class="w"></span>

<span class="k">fun</span><span class="w"> </span><span class="n">first_answer</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="k">of</span><span class="w"> </span>
<span class="w">		</span><span class="p">[]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">raise</span><span class="w"> </span><span class="n">NoAnswer</span><span class="w"></span>
<span class="w">	  </span><span class="p">|</span><span class="w"> </span><span class="n">x::xs&#39;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">of</span><span class="w"></span>
<span class="w">	  				 </span><span class="n">NONE</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">first_answer</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">xs&#39;</span><span class="w"></span>
<span class="w">	  			   </span><span class="p">|</span><span class="w"> </span><span class="n">SOME</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">y</span><span class="w"></span>

<span class="cm">(*</span>
<span class="cm">--suboptimal solution that applies f to all xs elements</span>
<span class="cm">--despite the fact that the appearance of NONE should make</span>
<span class="cm">--the process finish immediatelly.</span>

<span class="cm">fun all_answers f xs = </span>
<span class="cm">	let </span>
<span class="cm">		val opts = map f xs</span>
<span class="cm">		fun find(pending, checked) = </span>
<span class="cm">			case pending of</span>
<span class="cm">			  [] =&gt; SOME checked</span>
<span class="cm">			  | (NONE)::_ =&gt; NONE</span>
<span class="cm">			  | (SOME p)::ps =&gt; find(ps, p @ checked)</span>

<span class="cm">	in</span>
<span class="cm">		find(opts, [])</span>
<span class="cm">	end	  </span>
<span class="cm">*)</span><span class="w"></span>
<span class="k">fun</span><span class="w"> </span><span class="n">all_answers</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">	</span><span class="k">let</span><span class="w"> </span>
<span class="w">		</span><span class="k">fun</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="n">pending</span><span class="p">,</span><span class="w"> </span><span class="n">checked</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="n">pending</span><span class="w"> </span><span class="k">of</span><span class="w"></span>
<span class="w">			   </span><span class="p">[]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">SOME</span><span class="w"> </span><span class="n">checked</span><span class="w"></span>
<span class="w">			 </span><span class="p">|</span><span class="w"> </span><span class="n">x::xs</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">of</span><span class="w"> </span>
<span class="w">			  			  </span><span class="n">NONE</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NONE</span><span class="w"></span>
<span class="w">			  			</span><span class="p">|</span><span class="w"> </span><span class="n">SOME</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="n">@</span><span class="w"> </span><span class="n">checked</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="k">in</span><span class="w"></span>
<span class="w">		</span><span class="n">find</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"></span>
<span class="w">	</span><span class="k">end</span><span class="w">	  </span>

<span class="k">fun</span><span class="w"> </span><span class="n">count_wildcards</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"></span>
<span class="k">fun</span><span class="w"> </span><span class="n">count_wild_and_variable_lengths</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"></span>
<span class="k">fun</span><span class="w"> </span><span class="n">count_some_var</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="p">=</span><span class="n">s</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"></span>

<span class="k">fun</span><span class="w"> </span><span class="n">check_pat</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">	</span><span class="k">let</span><span class="w"></span>
<span class="w">		</span><span class="k">fun</span><span class="w"> </span><span class="n">get_vars</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">=</span><span class="w"></span>
<span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">of</span><span class="w"></span>
<span class="w">	  		    </span><span class="n">Variable</span><span class="w"> </span><span class="n">x</span><span class="w">        </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"></span>
<span class="w">	  		  </span><span class="p">|</span><span class="w"> </span><span class="n">TupleP</span><span class="w"> </span><span class="n">ps</span><span class="w">         </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">foldl</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">vs</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">get_vars</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="n">@</span><span class="w"> </span><span class="n">vs</span><span class="p">)</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">ps</span><span class="w"></span>
<span class="w">	  		  </span><span class="p">|</span><span class="w"> </span><span class="n">ConstructorP</span><span class="p">(_,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">get_vars</span><span class="w"> </span><span class="n">p</span><span class="w"></span>
<span class="w">	  		  </span><span class="p">|</span><span class="w"> </span><span class="p">_</span><span class="w">                 </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>

<span class="w">    	</span><span class="k">fun</span><span class="w"> </span><span class="n">repeated</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">    		</span><span class="k">case</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="k">of</span><span class="w"> </span>
<span class="w">    			</span><span class="p">[]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">false</span><span class="w"></span>
<span class="w">    		  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">x::xs&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="n">exists</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">xs&#39;</span><span class="w"> </span><span class="k">orelse</span><span class="w"> </span><span class="n">repeated</span><span class="w"> </span><span class="n">xs&#39;</span><span class="w"></span>
<span class="w">	</span><span class="k">in</span><span class="w"></span>
<span class="w">		</span><span class="n">not</span><span class="p">(</span><span class="n">repeated</span><span class="w"> </span><span class="p">(</span><span class="n">get_vars</span><span class="w"> </span><span class="n">p</span><span class="p">))</span><span class="w"></span>
<span class="w">	</span><span class="k">end</span><span class="w"></span>

<span class="k">fun</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">pattern</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">	</span><span class="k">let</span><span class="w"></span>
<span class="w">		</span><span class="k">val</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">all_answers</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="p">))</span><span class="w"></span>
<span class="w">	</span><span class="k">in</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">of</span><span class="w"> </span>
<span class="w">			 	</span><span class="p">(</span><span class="n">Wildcard</span><span class="p">,_)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">SOME</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">		   	  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">UnitP</span><span class="p">,</span><span class="w"> </span><span class="n">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">SOME</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">		      </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">ConstP</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="p">=</span><span class="n">v</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">SOME</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">NONE</span><span class="w"></span>
<span class="w">		      </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Variable</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">SOME</span><span class="w"> </span><span class="p">[(</span><span class="n">p</span><span class="p">,</span><span class="n">Const</span><span class="w"> </span><span class="n">v</span><span class="p">)]</span><span class="w"></span>
<span class="w">		      </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">ConstructorP</span><span class="w"> </span><span class="p">(</span><span class="n">pn</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">),</span><span class="w"> </span><span class="n">Constructor</span><span class="w"> </span><span class="p">(</span><span class="n">vn</span><span class="p">,</span><span class="n">v</span><span class="p">))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">pn</span><span class="p">=</span><span class="n">vn</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">[(</span><span class="n">v</span><span class="p">,</span><span class="n">p</span><span class="p">)]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">NONE</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">TupleP</span><span class="w"> </span><span class="n">ps</span><span class="p">,</span><span class="w"> </span><span class="n">Tuple</span><span class="w"> </span><span class="n">vs</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span><span class="w"> </span>
<span class="w">			  							 </span><span class="k">then</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">ListPair</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span><span class="n">ps</span><span class="p">))</span><span class="w"> </span>
<span class="w">			  							 </span><span class="k">else</span><span class="w"> </span><span class="n">NONE</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NONE</span><span class="w"></span>
<span class="w">	</span><span class="k">end</span><span class="w"></span>


<span class="k">fun</span><span class="w"> </span><span class="n">first_match</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SOME</span><span class="w"> </span><span class="p">(</span><span class="n">first_answer</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">match</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="k">handle</span><span class="w"> </span><span class="n">NoAnswer</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NONE</span><span class="w"></span>

<span class="k">exception</span><span class="w"> </span><span class="n">ConstructorNotFound</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">*</span><span class="w"> </span><span class="n">typ</span><span class="w"></span>
<span class="k">exception</span><span class="w"> </span><span class="n">IncompatiblePatterns</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">pattern</span><span class="w"> </span><span class="n">*</span><span class="w"> </span><span class="n">pattern</span><span class="w"></span>

<span class="k">fun</span><span class="w"> </span><span class="n">typecheck_patterns</span><span class="p">(</span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">patterns</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">	</span><span class="k">let</span><span class="w"></span>

<span class="w">		</span><span class="cm">(*t2 type declared, t1 type of pattern*)</span><span class="w"></span>
<span class="w">		</span><span class="k">fun</span><span class="w"> </span><span class="n">is_compatible</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="k">of</span><span class="w"></span>
<span class="w">				</span><span class="p">(</span><span class="n">Anything</span><span class="p">,_)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">true</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(_,</span><span class="w"> </span><span class="n">Anything</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">true</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">UnitT</span><span class="p">,</span><span class="w"> </span><span class="n">UnitT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">true</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">IntT</span><span class="p">,</span><span class="w"> </span><span class="n">IntT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">true</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">TupleT</span><span class="p">(</span><span class="n">ts1</span><span class="p">),</span><span class="w"> </span><span class="n">TupleT</span><span class="p">(</span><span class="n">ts2</span><span class="p">))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">ts1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">ts2</span><span class="p">)</span><span class="w"> </span><span class="k">andalso</span><span class="w"> </span><span class="n">ListPair</span><span class="p">.</span><span class="n">all</span><span class="w"> </span><span class="n">is_compatible</span><span class="w"> </span><span class="p">(</span><span class="n">ts1</span><span class="p">,</span><span class="n">ts2</span><span class="p">)</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Datatype</span><span class="p">(</span><span class="n">s1</span><span class="p">),</span><span class="w"> </span><span class="n">Datatype</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">s2</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">false</span><span class="w"></span>

<span class="w">		</span><span class="k">fun</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">argtype</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">			</span><span class="k">let</span><span class="w"></span>
<span class="w">				</span><span class="k">val</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="n">find</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">andalso</span><span class="w"> </span><span class="n">is_compatible</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">argtype</span><span class="p">))</span><span class="w"> </span><span class="n">types</span><span class="w"></span>
<span class="w">			</span><span class="k">in</span><span class="w"></span>
<span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">of</span><span class="w"></span>
<span class="w">					</span><span class="n">NONE</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">raise</span><span class="w"> </span><span class="n">ConstructorNotFound</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">argtype</span><span class="p">)</span><span class="w"></span>
<span class="w">				  </span><span class="p">|</span><span class="w"> </span><span class="n">SOME</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Datatype</span><span class="w"> </span><span class="n">t</span><span class="w"> </span>
<span class="w">			</span><span class="k">end</span><span class="w"></span>

<span class="w">		</span><span class="k">fun</span><span class="w"> </span><span class="n">to_type</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"></span>
<span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="n">pattern</span><span class="w"> </span><span class="k">of</span><span class="w"></span>
<span class="w">				</span><span class="n">Wildcard</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Anything</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="n">UnitP</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">UnitT</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="n">ConstP</span><span class="p">(_)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">IntT</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="n">Variable</span><span class="p">(_)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Anything</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="n">TupleP</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">TupleT</span><span class="p">(</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">to_type</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="n">ps</span><span class="p">)</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="n">ConstructorP</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span><span class="w"> </span><span class="n">to_type</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w"></span>

<span class="w">		</span>
<span class="w">		</span><span class="k">fun</span><span class="w"> </span><span class="n">generalize</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span><span class="w"> </span><span class="k">of</span><span class="w"></span>
<span class="w">				</span><span class="p">(</span><span class="n">Wildcard</span><span class="p">,</span><span class="w"> </span><span class="n">Wildcard</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Wildcard</span><span class="p">,</span><span class="w"> </span><span class="n">Variable</span><span class="p">(_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Wildcard</span><span class="p">,</span><span class="w"> </span><span class="n">ConstP</span><span class="p">(_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p2</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Wildcard</span><span class="p">,</span><span class="w"> </span><span class="n">UnitP</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Wildcard</span><span class="p">,</span><span class="w"> </span><span class="n">ConstructorP</span><span class="p">(_,_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p2</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Wildcard</span><span class="p">,</span><span class="w"> </span><span class="n">TupleP</span><span class="p">(_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p2</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Variable</span><span class="p">(_),</span><span class="w"> </span><span class="n">Variable</span><span class="p">(_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Variable</span><span class="p">(_),</span><span class="w"> </span><span class="n">ConstP</span><span class="p">(_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p2</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Variable</span><span class="p">(_),</span><span class="w"> </span><span class="n">TupleP</span><span class="p">(_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p2</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Variable</span><span class="p">(_),</span><span class="w"> </span><span class="n">ConstructorP</span><span class="p">(_,_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p2</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">Variable</span><span class="p">(_),</span><span class="w"> </span><span class="n">Wildcard</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p2</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">ConstP</span><span class="p">(_),</span><span class="w"> </span><span class="n">ConstP</span><span class="p">(_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">ConstP</span><span class="p">(_),</span><span class="w"> </span><span class="n">Variable</span><span class="p">(_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">ConstP</span><span class="p">(_),</span><span class="w"> </span><span class="n">Wildcard</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">UnitP</span><span class="p">,</span><span class="w"> </span><span class="n">UnitP</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">UnitP</span><span class="p">,</span><span class="w"> </span><span class="n">Wildcard</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p2</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">TupleP</span><span class="p">(_),</span><span class="w"> </span><span class="n">Variable</span><span class="p">(_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">TupleP</span><span class="p">(</span><span class="n">ps1</span><span class="p">),</span><span class="w"> </span><span class="n">TupleP</span><span class="p">(</span><span class="n">ps2</span><span class="p">))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">ps1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">ps2</span><span class="p">)</span><span class="w">  </span>
<span class="w">			  								  </span><span class="k">then</span><span class="w"> </span><span class="n">TupleP</span><span class="p">(</span><span class="n">ListPair</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="n">generalize</span><span class="w"> </span><span class="p">(</span><span class="n">ps1</span><span class="p">,</span><span class="n">ps2</span><span class="p">))</span><span class="w"></span>
<span class="w">			  								  </span><span class="k">else</span><span class="w"> </span><span class="k">raise</span><span class="w"> </span><span class="n">IncompatiblePatterns</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">TupleP</span><span class="p">(_),</span><span class="w"> </span><span class="n">Wildcard</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">ConstructorP</span><span class="p">(_,_),</span><span class="w"> </span><span class="n">Variable</span><span class="p">(_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">ConstructorP</span><span class="p">(_,_),</span><span class="w"> </span><span class="n">ConstructorP</span><span class="p">(_,_))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">to_type</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">to_type</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span><span class="w"></span>
<span class="w">			  											  </span><span class="k">then</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  											  </span><span class="k">else</span><span class="w"> </span><span class="k">raise</span><span class="w"> </span><span class="p">(</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Incompatible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="n">IncompatiblePatterns</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">))</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">ConstructorP</span><span class="p">(_,_),</span><span class="w"> </span><span class="n">Wildcard</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">p1</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Exhausted options</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="k">raise</span><span class="w"> </span><span class="n">IncompatiblePatterns</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">))</span><span class="w"></span>
<span class="w">				</span>
<span class="w">			  </span>
<span class="w">		</span><span class="k">fun</span><span class="w"> </span><span class="n">check</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span><span class="w"> </span><span class="n">prevpattern</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="n">patterns</span><span class="w"> </span><span class="k">of</span><span class="w"> </span>
<span class="w">				</span><span class="p">[]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">SOME</span><span class="p">(</span><span class="n">prevpattern</span><span class="p">)</span><span class="w"></span>
<span class="w">			  </span><span class="p">|</span><span class="w"> </span><span class="p">(</span><span class="n">p::ps</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">check</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span><span class="n">generalize</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">prevpattern</span><span class="p">))</span><span class="w"> </span>
<span class="w">			  				</span><span class="k">handle</span><span class="w"> </span><span class="n">exn</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NONE</span><span class="w"></span>
<span class="w">	</span><span class="k">in</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="n">patterns</span><span class="w"> </span><span class="k">of</span><span class="w"></span>
<span class="w">			</span><span class="p">[]</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">SOME</span><span class="w"> </span><span class="n">Anything</span><span class="w"></span>
<span class="w">		  </span><span class="p">|</span><span class="w"> </span><span class="n">p::ps</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">check</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="k">of</span><span class="w"></span>
<span class="w">		  				</span><span class="n">NONE</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NONE</span><span class="w"></span>
<span class="w">		  			  </span><span class="p">|</span><span class="w"> </span><span class="n">SOME</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">SOME</span><span class="p">(</span><span class="n">to_type</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="k">handle</span><span class="w"> </span><span class="n">ConstructorNotFound</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Puff: &quot;</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">cn</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="n">NONE</span><span class="p">)</span><span class="w"></span>
<span class="w">		  			                                      </span><span class="p">|</span><span class="w"> </span><span class="n">exn</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NONE</span><span class="w"></span>
<span class="w">	</span><span class="k">end</span><span class="w"></span>


<span class="k">fun</span><span class="w"> </span><span class="n">only_capitals&#39;</span><span class="p">(</span><span class="w"> </span><span class="n">wordList</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">wordList&#39;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">Char</span><span class="p">.</span><span class="n">isUpper</span><span class="p">(</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="w"> </span><span class="n">wordList&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">wordList</span><span class="w"></span>


<span class="k">fun</span><span class="w"> </span><span class="n">aux1</span><span class="w"> </span><span class="p">(</span><span class="n">pat</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="n">pat</span><span class="w"> </span><span class="k">of</span><span class="w"> </span>
<span class="w">		</span><span class="n">Variable</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">x::acc</span><span class="w"></span>
<span class="w">		</span><span class="p">|</span><span class="w"> </span><span class="n">TupleP</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="n">foldl</span><span class="p">(</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">aux1</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="n">acc</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="n">@acc</span><span class="w"></span>
<span class="w">		</span><span class="p">|</span><span class="w"> </span><span class="n">ConstructorP</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">aux1</span><span class="p">(</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="p">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
</pre></div>
</body>
</html>
